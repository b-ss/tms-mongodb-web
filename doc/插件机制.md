# 支持插件机制

插件是通过配置的方式，提供给用户对 mongodb 管理对象（db，collection，document）进行操作的组件。

## plugin 配置文件

在 back/config 下创建 plugin.js 配置。

注：目前仅支持外部接口方式，故需要在 config 目录下建立 trusted-hosts.js 文件，配置登录权限白名单。

## sendConfig 参数说明

| 参数       | 说明   |
| ---------- | ------ |
| db         | 数据库 |
| collection | 集合   |
| document   | 文档   |

## 每条接口参数说明

| 参数                                   | 说明                                                  |
| -------------------------------------- | ----------------------------------------------------- |
| **数组中第一项**                       |                                                       |
| url                                    | 接口地址                                              |
| method                                 | 接口方法                                              |
| **数组中第二项(机制内配置信息)**       |                                                       |
| docSchemas                             | 是否需要传递 docSchemas 信息                          |
| isNeedGetParams                        | 是否需要将 get 方式接收到的参数传递给外部接口         |
| callback                               | 是否需要回调函数，如果是则需指定 path 及 callbackName |
| **数组中第三项(前端用户展示配置信息)** |                                                       |
| name                                   | 按钮名称                                              |
| description                            | 描述信息                                              |
| batch                                  | 按钮所拥有的过滤项条件                                |
| auth                                   | <Array> 权限控制                                      |
| isConfirm                              | 是否需要二次确认                                      |
| confirmMsg                             | 二次确认提示信息                                      |
| confirmText                            | 自定义确认按钮信息                                    |
| cancelText                             | 自定义取消按钮信息                                    |
| successParams                          | 确认之后需要额外传递给后端的信息(字段由配置文件决定)  |
| failParams                             | 取消之后需要额外传递给后端的信息(字段由配置文件决定)  |
| defaultParams                          | 默认参数项,前端会将该参数合并至 get 参数中            |

## sendConfig 格式

```
sendConfig = {
  db: [],
  collection: [],
  document: [
    [
      {url: '/it/api/checkApi/tDMobile', method: 'post'}, { docSchemas: true, isNeedGetParams: true, callback: { path: `${sendCBPath}/document`, callbackName: 'unSubScribeCB' } }, { name: '号码退订', description: '号码退订', batch: ["all", "filter", "ids"], isConfirm: true, confirmMsg: '提示信息', confirmText: '自定义确认按钮信息', cancelText: '自定义取消按钮信息', successParams: { bucket: 'pool', isZero: 'Y' }, failParams: { bucket: 'pool', isZero: 'N' }}
    ],
  ]
}
```

## receiveConfig 参数说明

| 参数 | 说明                 |
| ---- | -------------------- |
| it   | 模块名称，以模块划分 |

## 每层模块内的参数说明

| 参数        | 说明                                                    |
| ----------- | ------------------------------------------------------- |
| name        | 接口名称                                                |
| event       | 模块特有属性(需与外部接口传递值保存一致)                |
| eventType   | 模块特有属性(需与外部接口传递值保存一致)                |
| docSchemas  | 是否需要传递 docSchemas 信息                            |
| quota       | 更新数据指标，默认不设置，则以\_id 为准                 |
| callback    | 是否需要回调函数，如果是则需指定 path 及 callbackName   |
| noActionLog | 设置为 true 代表，不进行日志记录;默认为 false           |
| before      | 是否需要入库前置操作，如果是则需指定 path 及 beforeName |

## callback 提供的参数说明

| 参数    | 说明               |
| ------- | ------------------ |
| data    | 数据项，不包含\_id |
| docIds  | ids 集合           |
| cl      |                    |
| existDb |                    |
| clName  | 表名               |
| query   | query 参数         |

## receiveConfig 格式

```
// 接收配置-以模块划分
receiveConfig = {
  it: [
    { name: '**', event: '**', eventType: '**', quota: '**' },
  ]
}
```

## 最终导出数据格式，必须包含 sendConfig

```
module.exports = {
  sendConfig,
  receiveConfig
}
```

## 外部插件

外部插件需根据以下规定返回参数
接收参数
| 参数 | 说明 |
| ------ | ---------------- |
| data | 可操作的数据源 |

返回参数

| 参数 | 说明               |
| ---- | ------------------ |
| code | 为 0 代表成功      |
| data | 操作成功返回数据   |
| msg  | 成功或失败信息提示 |

返回参数需与 columns 定义的字段相匹配，才可成功操作 mongodb
