# 介绍

实现从集合 A（主集合） 的向集合 B（从集合） 全量或实时复制数据。一个主集合可以向多个从集合复制数据，一个从集合可以从多个主集合接收数据。

实时复制数据需要使用`ChangeStream`，因此，若需要实时复制必须给`MongoDB`设置`Replica Set`。

**从集合**与普通集合在使用上并没有严格的区别，也需要定义`schema`等。但是，系统会在从集合上自动添加`__pri`字段用于记录对应**主集合**中的文档信息，其内容如下：

| 内置字段     | 说明                            | 必填 | 类型      |
| ------------ | ------------------------------- | ---- | --------- |
| \_\_pri      |                                 | 是   | object    |
| \_\_pri.db   | 文档所属数据库名称（sysname）。 | 是   | string    |
| \_\_pri.cl   | 文档所属集合名称（sysname）。   | 是   | string    |
| \_\_pri.id   | 文档原始 id（\_id）。           | 是   | ObjectId  |
| \_\_pri.time | 最近一次复制时间。              | 是   | 13 位整型 |

# 配置复制关系

`tms_admin.replica_map`集合用于记录集合间的复制关系。

自建集合对象（tms_admin.mongodb_object）中的`usage`字段用于指定集合用途，当值为`1`时，说明集合作为从集合使用。

管理员用户可以创建**从集合**；管理员用户和普通用户可以查看所有**从集合**。

管理员和普通用户可以建立或删除**主集合到从集合的复制关系**。

管理员用户可以查看全部集合复制关系。

普通用户可以查看一个集合的全部复制关系。

| API             | 说明                           |
| --------------- | ------------------------------ |
| /replica/list   | 查看已有集合复制关系。         |
| /replica/create | 建立主集合到从集合的复制关系。 |
| /replica/remove | 删除主集合到从集合的复制关系。 |

# 全量复制

管理员用户和普通用户都可以在任意时刻进行由**主集合**到**从集合**的全量复制。进行全量复制前，必须先建立集合间的复制关系。

| API                  | 说明                           |
| -------------------- | ------------------------------ |
| /replica/synchronize | 执行主集合到从集合的全量同步。 |

支持批量执行？支持全部执行？

# 实时复制

必须配置了`replica set`才能支持实时复制，系统默认不打开集合实时复制功能，需要通过环境变量`TMW_REALTIME_REPLICA`打开。

系统启动时监听`replica_map`，实时更新复制逻辑。

## mongodb 复制集

配置复制集

primary

secondaries

arbiter

## ChangeStream

性能问题。

可靠性问题。

初始化问题。

# 在从集合上执行操作

所有对从集合中记录的操作，都要转换为对主集合中相应记录的操作，然后再由主集合复制到从集合。

不否允许用户在从集合中直接添加文档。

在从集合上可以执行主集合可用的插件，但是，都要转为对主集合的操作。

# 待优化问题

主集合和从集合的`schema`是否要求相同？是否只同步主集合中和从集合的`schema`一致的数据？

是否支持按照主集合`schema`和从集合`schema`的映射关系同步数据？

是否可以利用`perset`机制自动建立集合复制关系？

删除主集合或从集合时如何处理已有的复制关系？有复制关系时就不允许删？

修改主集合或从集合的名称时如何处理已有的复制关系？复制关系上已经记录`clId`还需要记录冗余信息吗？数据名对应的是`sysname`，这个不会发生改变，不受影响；集合的名称是允许改变的，而且和 mongodb 中的名称一致。集合的名字还影响了从集合中记录的`__pri`数据。

# 参考：

https://docs.mongodb.com/manual/reference/operator/update/#update-operators

[Generating Globally Unique Identifiers for Use with MongoDB](https://www.mongodb.com/blog/post/generating-globally-unique-identifiers-for-use-with-mongodb)
